---
title: tcp三次握手
comments: true
typora-root-url: ../../source/
date: 2020-01-04 14:46:08
tags:
- TCP
- 三次握手
- SYN
---

> 来自[《携程 Dubbo 连接超时问题的排查》](https://www.infoq.cn/article/y5KYxYeVPXAlHI1Y8ylX?utm_source=rss&utm_medium=article)

<!--more-->

# 转：tcp连接超时排查

## 背景

这篇博客记录了携程某个服务在刚发布后会出现少量connection timeout的异常。

经过以下排查步骤后确定是因为linux下netty启动时设置默认backlog值太小导致syn被丢弃导致的。

1. 服务的端口是否异步打开：是否先服务注册成功，之后才打开端口
2. 注册中心推送有误：服务是否还没注册完就推送到了客户端
3. 端口打开后是否可能被关闭

根据日志判断在服务端accept中部分连接被丢弃，根据抓包显示服务端有一段时间收到syn没有回复ack。

1. 确认不是应用层丢弃

最后发现是全连接队列满导致的SYN丢包。

```bash
$ netstat -s
3220 times the listen queue of a socket  overflowed 
3220 SYNs to LISTEN sockets dropped
```

## 三次握手

![携程Dubbo连接超时问题的排查](https://static001.infoq.cn/resource/image/e6/8f/e6a4fd23582d6f5175391aa5b414108f.png)

1、客户端使用 connect() 向服务端发起连接请求（发送 syn 包），此时客户端的 TCP 的状态为 SYN_SENT；

2、服务端在收到 syn 包后，将 TCP 相关信息放到 syn queue 中，同时向客户端发送 syn+ack，服务端 TCP 的状态为 SYN_RCVD；

3、客户端收到服务端的 syn+ack 后，向服务端发送 ack，此时客户端的 TCP 的状态为 ESTABLISHED。服务端收到 ack 确认后，从 synqueue 里将 TCP 信息取出，并放到 accept queue 中，此时服务端的 TCP 的状态为 ESTABLISHED。

overflowed 代表 accept queue 溢出，dropped 代表 syn queue 溢出。

源码显示： overflow 的时候 TCP dropped 也会增加，也就是 dropped 一定大于等于 overflowed。但是结果显示 overflowed 和 dropped 是一样的（都是 3220），只能说明 accept queue 溢出了，而 syn queue 溢出为 0（3220-3220=0）。

并且有：建连接的时候，会判断 accept queue，如果 acceptqueue 满了，就会 drop，即把这个 syn 包丢掉了。

Netty3启动时默认backlog为50，Netty4为1024.